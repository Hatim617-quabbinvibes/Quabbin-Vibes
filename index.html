<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quabbin Vibes ‚Äî Regional Events & Reviews</title>
<meta name="description" content="Events, reviews, and guides across Western & Central New England." />
<link rel="preconnect" href="https://images.unsplash.com">
<style>
/* ====== Tokens ====== */
:root{
  --bg:#0b0f17; --panel:#0f141d; --elev:#111827; --ink:#e8eef9; --muted:#9fb0c9;
  --brand:#7a8cff; --brand2:#25d0a6; --danger:#ff6b6b; --accent:#ffd166;
  --radius:16px; --shadow:0 16px 48px rgba(0,0,0,.35);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0a0f17;color:var(--ink);overflow-x:hidden}
a{color:inherit}
/* ====== Header ====== */
header{position:fixed;top:0;left:0;right:0;z-index:1000;backdrop-filter:blur(16px);background:rgba(10,15,23,.6);border-bottom:1px solid rgba(255,255,255,.06)}
.nav{max-width:1200px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:16px}
.brand{display:flex;align-items:center;gap:10px;text-decoration:none;font-weight:900}
.badge{width:28px;height:28px;border-radius:9px;background:conic-gradient(from 210deg,var(--brand),var(--brand2),var(--accent),var(--brand));box-shadow:0 8px 18px rgba(122,140,255,.35)}
.spacer{flex:1}
.nav a.link{color:var(--muted);text-decoration:none;font-weight:800}
.nav a.link:hover{color:var(--ink)}
.cta{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0a0f17;padding:10px 14px;border-radius:12px;font-weight:900;text-decoration:none;border:0}
/* ====== Pages framework ====== */
main{padding-top:72px}
.page{display:none;max-width:1200px;margin:0 auto;padding:26px 18px}
.page.active{display:block}
/* ====== Hero (home) ====== */
.hero{display:grid;grid-template-columns:1.1fr .9fr;gap:22px;margin-top:10px}
.hero-copy .kicker{display:inline-flex;align-items:center;gap:8px;padding:7px 11px;border-radius:999px;background:rgba(122,140,255,.12);border:1px solid rgba(122,140,255,.25);color:var(--brand);font-weight:900}
.hero h1{font-size:clamp(2.2rem,3.4vw + 1rem,3.8rem);line-height:1.08;margin:12px 0 6px}
.hero p{color:var(--muted)}
.hero-actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:10px;padding:11px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:900;text-decoration:none;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0a0f17;border:0}
.hero-art{position:relative;border-radius:var(--radius);min-height:360px;background:url('https://images.unsplash.com/photo-1518972559570-7cc1309f3229?auto=format&fit=crop&w=1500&q=60') center/cover no-repeat;overflow:hidden;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.06)}
.hero-art:after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(11,15,23,.05),rgba(11,15,23,.6))}
.credit{position:absolute;right:12px;bottom:12px;background:rgba(0,0,0,.5);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:.9rem}
/* ====== Sections ====== */
.section-title{font-size:1.6rem;margin:6px 0 10px}
.carousel{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(260px,1fr);gap:14px;overflow:auto;scroll-snap-type:x mandatory;padding-bottom:6px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden;scroll-snap-align:start;box-shadow:0 8px 28px rgba(0,0,0,.25)}
.card .img{height:150px;background:#1a2234 center/cover no-repeat;position:relative}
.datechip{position:absolute;right:10px;top:10px;background:rgba(255,255,255,.9);color:#0a0f17;padding:6px 9px;border-radius:10px;font-weight:900;font-size:.85rem}
.card .meta{padding:12px}
.card .meta p{color:var(--muted);margin-top:6px}
.chip{display:inline-block;padding:6px 9px;border-radius:999px;background:#131b2a;border:1px solid rgba(255,255,255,.1);font-size:.8rem;color:#cfe0ff;margin-top:8px}
/* ====== Filters & Grids ====== */
.filterbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.input,.select{background:#0f1522;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:11px 12px;border-radius:12px;min-width:180px}
.button{padding:12px 16px;border-radius:12px;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0a0f17;border:0}
.grid{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
.event{position:relative;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.08);background:#111827;box-shadow:var(--shadow)}
.event .photo{height:140px;background:#1e273a center/cover no-repeat}
.event .body{padding:12px}
.event .title{font-weight:900}
.event .muted{color:var(--muted);font-size:.95rem;margin-top:6px}
.event .desc{color:#cbd6ec;margin-top:7px;font-size:.95rem}
/* ====== Blog cards ====== */
.post{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden}
.post .img{height:150px;background:#1a2234 center/cover no-repeat}
.post .meta{padding:12px}
.tag{display:inline-block;padding:5px 8px;border-radius:8px;background:#172033;border:1px solid rgba(255,255,255,.06);font-size:.8rem;color:#c7d2e9;margin-right:6px}
/* ====== Footer ====== */
footer{margin-top:26px;background:#070b12;border-top:1px solid rgba(255,255,255,.06)}
.foot{max-width:1200px;margin:0 auto;padding:24px 18px;display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
.copy{text-align:center;border-top:1px solid rgba(255,255,255,.06);padding:14px;color:#8fa1bd;position:relative}
#adminDot{position:absolute;right:10px;bottom:12px;width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35);cursor:pointer}
/* ====== Admin ====== */
#admin{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;z-index:2000;align-items:center;justify-content:center}
.panel{width:min(94vw,1100px);height:88vh;background:#0c111a;border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
.head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.1)}
.tabs{display:flex;gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.1);flex-wrap:wrap}
.tab{border:0;padding:9px 12px;border-radius:10px;background:#121829;color:#cfe0ff;font-weight:900;cursor:pointer}
.tab.active{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0a0f17}
.body{flex:1;overflow:auto;padding:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:9px;border-top:1px solid rgba(255,255,255,.1);text-align:left}
.btn{border:1px solid rgba(255,255,255,.14);background:#0f1522;color:#eaf1fe;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#0a0f17}
.btn.danger{background:var(--danger);border-color:transparent;color:#fff}
.formgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
textarea.input{min-height:120px}
dialog{border:0;border-radius:16px;max-width:720px;width:94vw;padding:0}
@media (max-width:900px){.hero{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <nav class="nav">
    <a class="brand" href="#" onclick="route('home')"><span class="badge"></span> <span id="logoText">Quabbin Vibes</span></a>
    <a class="link" href="#" onclick="route('events')">Events</a>
    <a class="link" href="#" onclick="route('reviews')">Reviews</a>
    <a class="link" href="#" onclick="route('venues')">Venues</a>
    <a class="link" href="#" onclick="route('about')">About</a>
    <span class="spacer"></span>
    <a class="cta" href="#" onclick="route('submit')">Submit Event</a>
  </nav>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="page active">
    <div class="hero">
      <div class="hero-copy">
        <span class="kicker">Western & Central New England</span>
        <h1 id="heroTitle">Find the good stuff every week</h1>
        <p id="heroSub">Curated events plus honest reviews of venues, restaurants, hikes & more.</p>
        <div class="hero-actions">
          <a class="btn primary" href="#" onclick="route('events')">Browse Events</a>
          <a class="btn" href="#" onclick="route('reviews')">Read Reviews</a>
        </div>
      </div>
      <div class="hero-art" id="heroArt"><div class="credit" id="heroCredit">üì∏ Quabbin Vibes</div></div>
    </div>

    <h2 class="section-title">Featured This Week</h2>
    <div id="featCarousel" class="carousel"></div>

    <h2 class="section-title" style="margin-top:16px">Latest Reviews</h2>
    <div id="homePosts" class="grid"></div>
  </section>

  <!-- EVENTS PAGE -->
  <section id="events" class="page">
    <h2 class="section-title">Upcoming Events</h2>
    <div class="filterbar">
      <input id="q" class="input" placeholder="Search events, venues, tags‚Ä¶">
      <select id="area" class="select">
        <option value="all">All Areas</option>
        <option>Worcester</option><option>Pioneer Valley</option><option>Berkshires</option>
        <option>Vermont</option><option>Connecticut</option>
      </select>
      <select id="when" class="select">
        <option value="any">Anytime</option>
        <option value="today">Today</option>
        <option value="weekend">Weekend</option>
        <option value="7d">Next 7 days</option>
      </select>
      <button class="button" onclick="applyFilters()">Filter</button>
    </div>
    <div id="evGrid" class="grid"></div>
    <p id="evEmpty" style="text-align:center;color:var(--muted);display:none">No events match your filters.</p>
  </section>

  <!-- REVIEWS / BLOG -->
  <section id="reviews" class="page">
    <h2 class="section-title">Reviews & Guides</h2>
    <div id="postGrid" class="grid"></div>
  </section>

  <!-- VENUES -->
  <section id="venues" class="page">
    <h2 class="section-title">Featured Venues</h2>
    <div id="venueGrid" class="grid"></div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="page">
    <h2 class="section-title">About Quabbin Vibes</h2>
    <p id="aboutCopy" style="color:var(--muted);max-width:70ch">Local-first guide with pro photography. We cover Worcester to the Berkshires plus VT/NH/CT.</p>
  </section>

  <!-- CONTACT -->
  <section id="contact" class="page">
    <h2 class="section-title">Contact</h2>
    <form onsubmit="submitContact(event)" class="card" style="padding:14px;max-width:680px">
      <label>Name<br><input class="input" required></label><br>
      <label>Email<br><input type="email" class="input" required></label><br>
      <label>Message<br><textarea class="input" required></textarea></label><br>
      <button class="button" style="width:100%">Send</button>
    </form>
  </section>

  <!-- SUBMIT -->
  <section id="submit" class="page">
    <h2 class="section-title">Submit an Event</h2>
    <form onsubmit="addFromSubmit(event)" class="card" style="padding:14px;max-width:760px">
      <label>Event Name<br><input id="s_name" class="input" required></label><br>
      <div class="formgrid">
        <label>Date<input id="s_date" type="date" class="input" required></label>
        <label>Time<input id="s_time" class="input"></label>
        <label>Area<input id="s_area" class="input" placeholder="Worcester / Pioneer Valley ‚Ä¶"></label>
        <label>Location<input id="s_where" class="input" placeholder="Venue, City, State"></label>
      </div><br>
      <label>Image URL<input id="s_img" class="input" placeholder="https://‚Ä¶"></label><br>
      <label>Description<textarea id="s_desc" class="input"></textarea></label><br>
      <button class="button" style="width:100%">Submit</button>
    </form>
  </section>
</main>

<footer>
  <div class="foot">
    <div>
      <div class="section-title" style="margin:0">Quabbin Vibes</div>
      <p style="color:var(--muted)">Worcester ‚Ä¢ Pioneer Valley ‚Ä¢ Berkshires ‚Ä¢ VT ‚Ä¢ CT</p>
    </div>
    <div>
      <div class="section-title" style="margin:0">Quick Links</div>
      <p><a class="cta" href="#" onclick="route('submit')" style="display:inline-block;margin-top:6px">Submit an Event</a></p>
    </div>
  </div>
  <div class="copy">¬© <span id="year"></span> Quabbin Vibes ‚Äî All rights reserved. <span id="adminDot" title="."></span></div>
</footer>

<!-- ===== Admin Portal ===== -->
<div id="admin">
  <div class="panel">
    <div class="head">
      <strong>Admin</strong>
      <div>
        <button class="btn" onclick="exportJSON()">Export</button>
        <label class="btn"><input id="importFile" type="file" accept="application/json" style="display:none" onchange="importJSON(this.files[0])">Import</label>
        <button class="btn danger" onclick="closeAdmin()">Close</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="events">Events</button>
      <button class="tab" data-tab="posts">Posts</button>
      <button class="tab" data-tab="media">Media/Brand</button>
      <button class="tab" data-tab="pages">Page Copy</button>
      <button class="tab" data-tab="sources">Sources</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>
    <div class="body">
      <!-- EVENTS TAB -->
      <section id="tab-events">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="evSearch" class="input" placeholder="Search events‚Ä¶">
          <button class="btn primary" onclick="openEventModal()">New Event</button>
        </div>
        <table class="table">
          <thead><tr><th>Name</th><th>Date</th><th>Area</th><th>Where</th><th>Pub</th><th style="text-align:right">Actions</th></tr></thead>
          <tbody id="evTable"></tbody>
        </table>
      </section>

      <!-- POSTS TAB -->
      <section id="tab-posts" class="hidden">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button class="btn primary" onclick="openPostModal()">New Post</button>
        </div>
        <table class="table">
          <thead><tr><th>Title</th><th>Tag</th><th>Published</th><th style="text-align:right">Actions</th></tr></thead>
          <tbody id="postTable"></tbody>
        </table>
      </section>

      <!-- MEDIA/BRAND TAB -->
      <section id="tab-media" class="hidden">
        <div class="formgrid">
          <label>Logo Text<input id="f_logoText" class="input"></label>
          <label>Logo Image URL (optional)<input id="f_logoImg" class="input"></label>
          <label>Hero Image URL<input id="f_heroUrl" class="input"></label>
          <label>Hero Credit<input id="f_heroCredit" class="input"></label>
        </div>
        <button class="btn primary" style="margin-top:8px" onclick="saveBrand()">Save Branding</button>
        <div style="margin-top:10px">
          <label>Add to Media Library</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="mediaUrl" class="input" placeholder="https://‚Ä¶">
            <button class="btn" onclick="addMedia()">Add</button>
          </div>
          <div id="mediaGrid" class="grid" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- PAGES TAB -->
      <section id="tab-pages" class="hidden">
        <div class="formgrid">
          <label>Home Title<input id="p_homeTitle" class="input"></label>
          <label>Home Subtitle<textarea id="p_homeSub" class="input"></textarea></label>
          <label>About Copy<textarea id="p_about" class="input"></textarea></label>
        </div>
        <button class="btn primary" style="margin-top:8px" onclick="savePages()">Save Page Copy</button>
      </section>

      <!-- SOURCES TAB -->
      <section id="tab-sources" class="hidden">
        <p style="color:var(--muted)">Add feeds or pages to import events. Supports RSS, ICS, JSON, or HTML pages. We proxy with a safe reader if CORS blocks.</p>
        <div style="display:grid;grid-template-columns:1fr 140px 120px;gap:8px;margin:8px 0">
          <input id="srcUrl" class="input" placeholder="https://‚Ä¶">
          <select id="srcType" class="select">
            <option value="auto">Auto</option><option value="rss">RSS</option><option value="ics">ICS</option><option value="json">JSON</option><option value="page">Page</option>
          </select>
          <button class="btn" onclick="addSource()">Add</button>
        </div>
        <button class="btn" onclick="addRecorderPreset()">+ Greenfield Recorder preset</button>
        <div id="srcList" style="margin-top:8px"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn primary" onclick="runImport()">Run Import</button>
          <span id="importStatus" style="color:var(--muted)"></span>
        </div>
      </section>

      <!-- SETTINGS TAB -->
      <section id="tab-settings" class="hidden">
        <div class="formgrid">
          <label>Admin Passcode<input id="passInput" class="input" placeholder="Change passcode"></label>
          <label>Analytics Provider<select id="analyticsProvider" class="select">
            <option value="none">None</option><option value="plausible">Plausible</option><option value="umami">Umami</option><option value="ga4">Google Analytics 4</option>
          </select></label>
          <label>Analytics ID / Domain<input id="analyticsId" class="input" placeholder="domain.com or G-XXXX‚Ä¶"></label>
        </div>
        <button class="btn primary" style="margin-top:8px" onclick="saveSettings()">Save Settings</button>
      </section>
    </div>
  </div>
</div>

<!-- Event Modal -->
<dialog id="evModal">
  <form method="dialog" class="card" style="border:0;margin:0;padding:0">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.1)">
      <strong id="evModalTitle">New Event</strong>
      <button class="btn" onclick="closeEventModal()">Close</button>
    </div>
    <div style="padding:12px" class="formgrid">
      <label>Name<input id="f_name" class="input" required></label>
      <label>Date<input id="f_date" type="date" class="input" required></label>
      <label>Time<input id="f_time" class="input"></label>
      <label>Area<input id="f_area" class="input"></label>
      <label>Where<input id="f_where" class="input"></label>
      <label>Image URL<input id="f_img" class="input"></label>
      <label>Tags (comma)<input id="f_tags" class="input"></label>
      <label>Description<textarea id="f_desc" class="input"></textarea></label>
      <label><input id="f_pub" type="checkbox"> Published</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid rgba(255,255,255,.1)">
      <button id="delBtn" type="button" class="btn danger hidden" onclick="deleteEvent()">Delete</button>
      <button id="saveBtn" type="button" class="btn primary" onclick="saveEvent()">Save</button>
    </div>
  </form>
</dialog>

<!-- Post Modal -->
<dialog id="postModal">
  <form method="dialog" class="card" style="border:0;margin:0;padding:0">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.1)">
      <strong id="postModalTitle">New Post</strong>
      <button class="btn" onclick="closePostModal()">Close</button>
    </div>
    <div style="padding:12px" class="formgrid">
      <label>Title<input id="p_title" class="input" required></label>
      <label>Tag (event, restaurant, hike, venue, review, news‚Ä¶)<input id="p_tag" class="input"></label>
      <label>Featured Image<input id="p_img" class="input"></label>
      <label>Excerpt<textarea id="p_excerpt" class="input"></textarea></label>
      <label>Content<textarea id="p_content" class="input"></textarea></label>
      <label><input id="p_pub" type="checkbox"> Published</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid rgba(255,255,255,.1)">
      <button id="postDelBtn" type="button" class="btn danger hidden" onclick="deletePost()">Delete</button>
      <button class="btn primary" type="button" onclick="savePost()">Save</button>
    </div>
  </form>
</dialog>

<script>
/* ================= STATE ================= */
const STORE='qv_full_v1';
const DEF={
  passcode:'QuabbinVibes2025!',
  brand:{logoText:'Quabbin Vibes',logoImg:'',heroUrl:'https://images.unsplash.com/photo-1518972559570-7cc1309f3229?auto=format&fit=crop&w=1500&q=60',heroCredit:'Quabbin Vibes'},
  pages:{homeTitle:'Find the good stuff every week',homeSub:'Curated events plus honest reviews of venues, restaurants, hikes & more.',about:'Local-first guide with pro photography. We cover Worcester to the Berkshires plus VT/NH/CT.'},
  media:[],
  venues:[
    {name:'Tanglewood Music Center',where:'Lenox, MA',img:'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?auto=format&fit=crop&w=1400&q=60',badge:'Outdoor ‚Ä¢ 18k cap'},
    {name:'Mass MoCA',where:'North Adams, MA',img:'https://images.unsplash.com/photo-1530062845286-05c2c27b8b56?auto=format&fit=crop&w=1400&q=60',badge:'Contemporary Arts'},
    {name:'Hanover Theatre',where:'Worcester, MA',img:'https://images.unsplash.com/photo-1491555103944-7c647fd857e6?auto=format&fit=crop&w=1400&q=60',badge:'Performing Arts'}
  ],
  events:[
    e('Tanglewood Summer Concert',+2,'19:00','Berkshires','Tanglewood, Lenox, MA','https://images.unsplash.com/photo-1492684223066-81342ee5ff30?auto=format&fit=crop&w=1400&q=60',['music','featured'],true),
    e('Northampton Farmers Market',+3,'09:00‚Äì13:00','Pioneer Valley','Main St, Northampton, MA','https://images.unsplash.com/photo-1470225620780-dba8ba36b745?auto=format&fit=crop&w=1400&q=60',['family','market'],true)
  ],
  posts:[
    p('Tanglewood: What to Know','event','https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1400&q=60','Tips for seating, parking, and what to bring.','Full writeup‚Ä¶',true),
    p('Best Patio Breweries in PV','restaurant','https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&w=1400&q=60','Our summer shortlist for outdoor pours.','Full post‚Ä¶',true)
  ],
  sources:[],
  analytics:{provider:'none',id:''}
};
function e(name,plusDays,time,area,where,img,tags,pub){const d=new Date();d.setDate(d.getDate()+plusDays);return{ id:crypto.randomUUID(),name,date:d.toISOString().slice(0,10),time,area,where,img,desc:'',tags,published:pub}}
function p(title,tag,img,excerpt,content,pub){return{ id:crypto.randomUUID(),title,tag,img,excerpt,content,published:pub}}
let DB=load();
function load(){try{return JSON.parse(localStorage.getItem(STORE))||DEF}catch{return DEF}}
function save(){localStorage.setItem(STORE,JSON.stringify(DB))}

/* ================ Router & init ================ */
function route(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo({top:0,behavior:'smooth'})}
document.getElementById('year').textContent=new Date().getFullYear();
applyBrand(); renderHome(); renderEvents(); renderPosts(); renderVenues();

/* ================ Brand & Pages ================ */
function applyBrand(){
  document.getElementById('logoText').textContent = DB.brand.logoText || 'Quabbin Vibes';
  const art = document.getElementById('heroArt');
  art.style.backgroundImage = `url('${DB.brand.heroUrl}')`;
  document.getElementById('heroCredit').textContent = 'üì∏ ' + (DB.brand.heroCredit||'');
  document.getElementById('heroTitle').textContent = DB.pages.homeTitle;
  document.getElementById('heroSub').textContent = DB.pages.homeSub;
  document.getElementById('aboutCopy').textContent = DB.pages.about;
}

/* ================ Home ================ */
function renderHome(){
  // featured carousel (events with 'featured')
  const feat = DB.events.filter(x=>x.published && (x.tags||[]).includes('featured')).sort((a,b)=>a.date.localeCompare(b.date));
  const c = document.getElementById('featCarousel'); c.innerHTML='';
  feat.forEach(e=>{
    const el=document.createElement('article'); el.className='card';
    el.innerHTML=`<div class="img" style="background-image:url('${e.img||""}')"><span class="datechip">${new Date(e.date).toLocaleDateString(undefined,{month:'short',day:'2-digit'})}</span></div>
    <div class="meta"><h3>${esc(e.name)}</h3><p>${esc(e.where||'')}</p><span class="chip">${esc((e.tags||[]).join(' ‚Ä¢ '))}</span></div>`;
    c.appendChild(el);
  });
  const posts = DB.posts.filter(p=>p.published).slice(0,4);
  const hp = document.getElementById('homePosts'); hp.innerHTML='';
  posts.forEach(po=> hp.appendChild(postCard(po)));
}

/* ================ Events & filters ================ */
const evGrid=document.getElementById('evGrid'), evEmpty=document.getElementById('evEmpty');
function withinWhen(dstr,when){const d=new Date(dstr),now=new Date();if(when==='any')return true;if(when==='today')return d.toDateString()===now.toDateString();if(when==='weekend')return[0,6].includes(d.getDay());if(when==='7d')return d>=startOfDay(now)&&(d-now)<=7*24*3600*1000;return true}
function startOfDay(x){const d=new Date(x);d.setHours(0,0,0,0);return d}
function renderEvents(){
  const list = DB.events.filter(e=>e.published).sort((a,b)=>a.date.localeCompare(b.date));
  drawEvents(list,evGrid,evEmpty);
}
function drawEvents(list,container,emptyEl){
  container.innerHTML='';
  if(!list.length){emptyEl.style.display='block';return}else emptyEl.style.display='none';
  list.forEach(e=>{
    const el=document.createElement('article'); el.className='event';
    el.innerHTML = `<div class="photo" style="background-image:url('${e.img||""}')"><div class="datechip">${new Date(e.date).toLocaleDateString(undefined,{month:'short',day:'2-digit'})}</div></div>
      <div class="body"><div class="title">${esc(e.name)}</div>
      <div class="muted">üìç ${esc(e.where||'')}</div>
      <div class="muted">üóì ${esc(e.date)} ${e.time?('‚Ä¢ '+esc(e.time)):""}</div>
      <p class="desc">${esc(e.desc||'')}</p></div>`;
    container.appendChild(el);
  });
}
function applyFilters(){
  const q=document.getElementById('q').value.trim().toLowerCase();
  const area=document.getElementById('area').value; const when=document.getElementById('when').value;
  const list=DB.events.filter(e=>e.published)
    .filter(e=> area==='all' ? true : (e.area||'').toLowerCase().includes(area.toLowerCase()))
    .filter(e=> withinWhen(e.date,when))
    .filter(e=> !q ? true : [e.name,e.where,e.area,(e.tags||[]).join(','),e.desc].join(' ').toLowerCase().includes(q))
    .sort((a,b)=>a.date.localeCompare(b.date));
  drawEvents(list,evGrid,evEmpty);
}

/* ================ Posts / Reviews ================ */
function postCard(po){
  const el=document.createElement('article'); el.className='post';
  el.innerHTML=`<div class="img" style="background-image:url('${po.img||""}')"></div>
    <div class="meta"><h3>${esc(po.title)}</h3><p style="margin-top:6px">${esc(po.excerpt||'')}</p>
    <div style="margin-top:8px"><span class="tag">${esc(po.tag||'review')}</span></div></div>`;
  return el;
}
function renderPosts(){
  const grid=document.getElementById('postGrid'); grid.innerHTML='';
  DB.posts.filter(p=>p.published).forEach(po=> grid.appendChild(postCard(po)));
}

/* ================ Venues ================ */
function renderVenues(){
  const grid=document.getElementById('venueGrid'); grid.innerHTML='';
  DB.venues.forEach(v=>{
    const el=document.createElement('article'); el.className='post';
    el.innerHTML=`<div class="img" style="background-image:url('${v.img||""}')"></div>
      <div class="meta"><h3>${esc(v.name)}</h3><p style="color:var(--muted)">${esc(v.where)}</p><span class="chip">${esc(v.badge||'')}</span></div>`;
    grid.appendChild(el);
  });
}

/* ================ Forms ================ */
function submitContact(ev){ev.preventDefault();alert('Thanks! We‚Äôll reply within 24 hours.');ev.target.reset()}
function addFromSubmit(ev){
  ev.preventDefault();
  const obj={ id:crypto.randomUUID(), name:s_name.value.trim(), date:s_date.value, time:s_time.value.trim(), area:s_area.value.trim(), where:s_where.value.trim(), img:s_img.value.trim(), desc:s_desc.value.trim(), tags:['submitted'], published:true };
  DB.events.push(obj); save(); renderHome(); renderEvents(); route('events'); alert('Submitted!');
  ev.target.reset();
}

/* ================= ADMIN ACCESS ================= */
document.getElementById('adminDot').onclick=()=>{
  const pw=prompt('Enter admin password:'); if(!pw)return;
  if(pw===(DB.passcode||'QuabbinVibes2025!')) openAdmin(); else alert('Incorrect password.');
};
function openAdmin(){
  document.getElementById('admin').style.display='flex';
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.onclick=()=>{document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
      document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      document.getElementById('tab-'+btn.dataset.tab).classList.remove('hidden');}
  });
  // Prefill forms
  f_logoText.value=DB.brand.logoText||''; f_logoImg.value=DB.brand.logoImg||'';
  f_heroUrl.value=DB.brand.heroUrl||''; f_heroCredit.value=DB.brand.heroCredit||'';
  p_homeTitle.value=DB.pages.homeTitle||''; p_homeSub.value=DB.pages.homeSub||''; p_about.value=DB.pages.about||'';
  passInput.value=DB.passcode||''; analyticsProvider.value=DB.analytics?.provider||'none'; analyticsId.value=DB.analytics?.id||'';
  drawMedia(); drawSources(); drawEventsTable(); drawPostsTable();
}
function closeAdmin(){document.getElementById('admin').style.display='none'}

/* ----- Events (admin) ----- */
let editingId=null;
function drawEventsTable(){
  const q=(evSearch.value||'').toLowerCase(); const tb=document.getElementById('evTable'); tb.innerHTML='';
  DB.events.filter(e=>!q||[e.name,e.where,e.area,(e.tags||[]).join(',')].join(' ').toLowerCase().includes(q))
    .sort((a,b)=>a.date.localeCompare(b.date))
    .forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${esc(e.name)}</td><td>${e.date}</td><td>${esc(e.area||'')}</td><td>${esc(e.where||'')}</td><td>${e.published?'Yes':'No'}</td>
      <td style="text-align:right"><button class="btn" onclick="editEvent('${e.id}')">Edit</button></td>`;
      tb.appendChild(tr);
    });
}
evSearch.addEventListener('input',drawEventsTable);
function openEventModal(){editingId=null; fillEventForm(); evModalTitle.textContent='New Event'; delBtn.classList.add('hidden'); evModal.showModal()}
function editEvent(id){editingId=id; const e=DB.events.find(x=>x.id===id); fillEventForm(e); evModalTitle.textContent='Edit Event'; delBtn.classList.remove('hidden'); evModal.showModal()}
function closeEventModal(){evModal.close()}
function fillEventForm(e={}){f_name.value=e.name||'';f_date.value=e.date||'';f_time.value=e.time||'';f_area.value=e.area||'';f_where.value=e.where||'';f_img.value=e.img||'';f_tags.value=(e.tags||[]).join(', ');f_desc.value=e.desc||'';f_pub.checked=!!e.published}
function saveEvent(){
  const obj={ id:editingId||crypto.randomUUID(), name:f_name.value.trim(), date:f_date.value.trim(), time:f_time.value.trim(), area:f_area.value.trim(), where:f_where.value.trim(),
    img:f_img.value.trim(), tags:f_tags.value.split(',').map(s=>s.trim()).filter(Boolean), desc:f_desc.value.trim(), published:f_pub.checked };
  if(!obj.name||!obj.date){alert('Name and date required');return}
  if(editingId){const i=DB.events.findIndex(x=>x.id===editingId); DB.events[i]=obj}else DB.events.push(obj);
  save(); renderHome(); renderEvents(); drawEventsTable(); closeEventModal();
}
function deleteEvent(){if(!editingId)return; if(!confirm('Delete this event?'))return; DB.events=DB.events.filter(x=>x.id!==editingId); save(); renderHome(); renderEvents(); drawEventsTable(); closeEventModal()}

/* ----- Posts (admin) ----- */
let editingPostId=null;
function drawPostsTable(){
  const tb=document.getElementById('postTable'); tb.innerHTML='';
  DB.posts.forEach(po=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${esc(po.title)}</td><td>${esc(po.tag||'')}</td><td>${po.published?'Yes':'No'}</td>
    <td style="text-align:right"><button class="btn" onclick="editPost('${po.id}')">Edit</button></td>`;
    tb.appendChild(tr);
  });
}
function openPostModal(){editingPostId=null; fillPostForm(); postModalTitle.textContent='New Post'; postDelBtn.classList.add('hidden'); postModal.showModal()}
function editPost(id){editingPostId=id; const po=DB.posts.find(x=>x.id===id); fillPostForm(po); postModalTitle.textContent='Edit Post'; postDelBtn.classList.remove('hidden'); postModal.showModal()}
function closePostModal(){postModal.close()}
function fillPostForm(po={}){p_title.value=po.title||'';p_tag.value=po.tag||'';p_img.value=po.img||'';p_excerpt.value=po.excerpt||'';p_content.value=po.content||'';p_pub.checked=!!po.published}
function savePost(){
  const obj={ id:editingPostId||crypto.randomUUID(), title:p_title.value.trim(), tag:p_tag.value.trim(), img:p_img.value.trim(), excerpt:p_excerpt.value.trim(), content:p_content.value.trim(), published:p_pub.checked };
  if(!obj.title){alert('Title required');return}
  if(editingPostId){const i=DB.posts.findIndex(x=>x.id===editingPostId); DB.posts[i]=obj}else DB.posts.push(obj);
  save(); renderHome(); renderPosts(); drawPostsTable(); closePostModal();
}
function deletePost(){if(!editingPostId)return; if(!confirm('Delete this post?'))return; DB.posts=DB.posts.filter(x=>x.id!==editingPostId); save(); renderHome(); renderPosts(); drawPostsTable(); closePostModal()}

/* ----- Media/Brand ----- */
function addMedia(){const u=mediaUrl.value.trim(); if(!u)return; DB.media.unshift(u); save(); mediaUrl.value=''; drawMedia()}
function drawMedia(){const g=document.getElementById('mediaGrid'); g.innerHTML=''; (DB.media||[]).forEach((url,i)=>{const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div class="img" style="height:120px;background-image:url('${url}')"></div><div class="meta" style="display:flex;gap:6px"><button class="btn" onclick="setHero(${i})">Hero</button><button class="btn" onclick="setLogoImg(${i})">Logo</button><button class="btn danger" onclick="delMedia(${i})">Remove</button></div>`; g.appendChild(card)})}
function setHero(i){DB.brand.heroUrl=DB.media[i]; save(); applyBrand(); alert('Hero updated')}
function setLogoImg(i){DB.brand.logoImg=DB.media[i]; DB.brand.logoText=''; save(); applyBrand(); alert('Logo updated')}
function delMedia(i){DB.media.splice(i,1); save(); drawMedia()}
function saveBrand(){DB.brand.logoText=f_logoText.value.trim()||DB.brand.logoText; DB.brand.logoImg=f_logoImg.value.trim(); DB.brand.heroUrl=f_heroUrl.value.trim()||DB.brand.heroUrl; DB.brand.heroCredit=f_heroCredit.value.trim()||DB.brand.heroCredit; save(); applyBrand(); alert('Branding saved.')}

/* ----- Page copy ----- */
function savePages(){DB.pages.homeTitle=p_homeTitle.value.trim()||DB.pages.homeTitle; DB.pages.homeSub=p_homeSub.value.trim()||DB.pages.homeSub; DB.pages.about=p_about.value.trim()||DB.pages.about; save(); applyBrand(); alert('Page copy saved.')}

/* ----- Sources / Scraper ----- */
function addSource(){const url=srcUrl.value.trim(); if(!url)return; DB.sources.push({url,type:srcType.value}); save(); srcUrl.value=''; drawSources()}
function drawSources(){const box=document.getElementById('srcList'); box.innerHTML=''; (DB.sources||[]).forEach((s,i)=>{const row=document.createElement('div'); row.className='card'; row.style.padding='10px'; row.style.margin='6px 0'; row.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:10px"><div><strong>${s.type||'auto'}</strong> ‚Äî ${s.url}</div><div><button class="btn" onclick="testImport(${i})">Test</button> <button class="btn danger" onclick="removeSource(${i})">Remove</button></div></div>`; box.appendChild(row)})}
function removeSource(i){DB.sources.splice(i,1); save(); drawSources()}
function addRecorderPreset(){
  // A few commonly used paths for the Greenfield Recorder site; keep the one that works and delete the rest in Admin
  const presets=[
    'https://www.recorder.com/section/living.calendar',
    'https://www.recorder.com/Calendar',
    'https://www.recorder.com/search?keyword=events',
  ];
  presets.forEach(u=> DB.sources.push({url:u,type:'auto'}));
  save(); drawSources(); alert('Preset URLs added. Use "Test" to see which one parses, then keep/remove.')
}
async function runImport(){
  importStatus.textContent='Importing‚Ä¶';
  let added=0;
  for(const s of (DB.sources||[])){
    try{ const items=await importFromSource(s); items.forEach(it=>{const key=it.name+it.date; if(!DB.events.some(e=>e.name+e.date===key)){DB.events.push(it); added++}}) }catch(err){ console.warn('Import error',err) }
  }
  save(); renderHome(); renderEvents(); drawEventsTable(); importStatus.textContent=`Imported ${added} event(s).`;
}
async function testImport(i){importStatus.textContent='Testing‚Ä¶'; try{const items=await importFromSource(DB.sources[i]); importStatus.textContent=`Parsed ${items.length} event(s).`}catch(e){importStatus.textContent='Error: '+e.message}}
function autoType(url){ if(/\.(rss|xml)(\?|$)/i.test(url))return'rss'; if(/\.(ics)(\?|$)/i.test(url))return'ics'; if(/\.(json)(\?|$)/i.test(url))return'json'; return'page' }
async function importFromSource(s){const t=s.type==='auto'?autoType(s.url):s.type; if(t==='rss')return importRSS(s.url); if(t==='ics')return importICS(s.url); if(t==='json')return importJSONurl(s.url); return importPage(s.url)}
async function fetchText(url){ try{const r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return await r.text()} catch(e){const prox='https://r.jina.ai/http/'+url.replace(/^https?:\/\//,''); const r=await fetch(prox); if(!r.ok) throw new Error('Proxy HTTP '+r.status); return await r.text()} }
async function importRSS(url){ const xml=await fetchText(url); const doc=new DOMParser().parseFromString(xml,'text/xml'); const items=[...doc.querySelectorAll('item,entry')].slice(0,80).map(x=>({title:(x.querySelector('title')?.textContent||'').trim(), desc:(x.querySelector('description,summary')?.textContent||'').trim(), when:(x.querySelector('pubDate,updated,dc\\:date')?.textContent||'').trim(), link:(x.querySelector('link')?.getAttribute?.('href')||x.querySelector('link')?.textContent||'').trim()})); return items.map(normItem) }
async function importICS(url){ const txt=await fetchText(url); const lines=txt.split(/\r?\n/); const out=[]; let cur={}; for(const ln of lines){ if(ln.startsWith('BEGIN:VEVENT')) cur={}; else if(ln.startsWith('SUMMARY:')) cur.title=ln.slice(8).trim(); else if(ln.startsWith('DTSTART')) cur.date=icsDate(ln.split(':')[1]); else if(ln.startsWith('LOCATION:')) cur.where=ln.slice(9).trim(); else if(ln.startsWith('DESCRIPTION:')) cur.desc=ln.slice(12).trim(); else if(ln.startsWith('END:VEVENT')){ if(cur.title&&cur.date) out.push(normItem({title:cur.title,desc:cur.desc,when:cur.date,where:cur.where})) } } return out }
async function importJSONurl(url){ const txt=await fetchText(url); const data=JSON.parse(txt); const arr=Array.isArray(data)?data:(data.items||data.events||[]); return arr.slice(0,120).map(it=>normItem({title:it.title||it.name,desc:it.description||it.desc,when:it.date||it.start||it.when,where:it.location||it.venue||'',img:it.image||it.img||'',link:it.url||it.link||''})) }
async function importPage(url){
  // Works nicely with the Greenfield Recorder via the proxy reader; we scan lines for date/title pairs.
  const text=await fetchText(url);
  const lines=text.split('\n').map(s=>s.trim()).filter(Boolean).slice(0,1200);
  const out=[];
  for(let i=0;i<lines.length;i++){
    const L=lines[i];
    const d=guessDate(L);
    if(d){
      let title=L.replace(/\s*\|\s*.*$/,'');
      if(lines[i+1] && lines[i+1].length>8 && !guessDate(lines[i+1])) title = lines[i+1];
      out.push(normItem({title,desc:L,when:d,link:url}));
    }
  }
  return out.slice(0,60);
}
function normItem({title,desc,when,where='',img='',link=''}){ const name=(title||'').replace(/\s+/g,' ').trim(); const date=safeISO(when)||safeISO(new Date()); return { id:crypto.randomUUID(), name, date, time:'', area:guessArea(where)||'Pioneer Valley', where:where||'', img, desc:(desc||'').slice(0,300), tags:['imported'], published:true, link } }
function safeISO(s){ try{const d=new Date(s); if(!isNaN(d)) return d.toISOString().slice(0,10)}catch{} return null }
function icsDate(s){ if(!s) return null; return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}` }
function guessDate(s){ if(!s) return null; const m=s.match(/(\b\d{1,2}[\/.-]\d{1,2}(?:[\/.-]\d{2,4})?\b)|(\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2}(?:,\s*\d{2,4})?\b)/i); return m? safeISO(m[0]): null }
function guessArea(where){ if(/worcester/i.test(where)) return 'Worcester'; if(/northampton|amherst|springfield|pioneer/i.test(where)) return 'Pioneer Valley'; if(/pittsfield|lenox|north adams|berkshir/i.test(where)) return 'Berkshires'; if(/vermont|brattleboro/i.test(where)) return 'Vermont'; if(/connecticut|hartford/i.test(where)) return 'Connecticut'; return 'Pioneer Valley' }

/* ----- Settings, analytics, import/export ----- */
function saveSettings(){DB.passcode=passInput.value||DB.passcode; DB.analytics={provider:analyticsProvider.value,id:analyticsId.value.trim()}; save(); injectAnalytics(); alert('Settings saved.')}
function injectAnalytics(){document.querySelectorAll('script[data-analytics]').forEach(s=>s.remove()); const {provider,id}=DB.analytics||{}; if(provider==='plausible'&&id){const s=document.createElement('script'); s.defer=true; s.src='https://plausible.io/js/script.js'; s.setAttribute('data-domain',id); s.dataset.analytics='plausible'; document.head.appendChild(s)} else if(provider==='umami'&&id){const s=document.createElement('script'); s.defer=true; s.src='https://cloud.umami.is/script.js'; s.setAttribute('data-website-id',id); s.dataset.analytics='umami'; document.head.appendChild(s)} else if(provider==='ga4'&&id){const g=document.createElement('script'); g.async=true; g.src=`https://www.googletagmanager.com/gtag/js?id=${id}`; g.dataset.analytics='ga4'; document.head.appendChild(g); const s=document.createElement('script'); s.dataset.analytics='ga4'; s.innerHTML=`window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','${id}');`; document.head.appendChild(s)}}
injectAnalytics();
function exportJSON(){const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quabbin-vibes.json'; a.click()}
async function importJSON(file){if(!file)return; const text=await file.text(); const obj=JSON.parse(text); if(!obj.events){alert('Invalid file');return} DB=obj; save(); applyBrand(); renderHome(); renderEvents(); renderPosts(); renderVenues(); drawSources(); drawMedia(); drawEventsTable(); drawPostsTable(); alert('Imported.')}

/* utils */
function esc(s){return (s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
</script>
</body>
                      </html>
